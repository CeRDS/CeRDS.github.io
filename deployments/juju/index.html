<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Juju deployment - Characterisation eResearch & Data Science (CeRDS)</title>
<meta name=generator content="Hugo 0.88.1">
<link href=https://cerds.github.io//index.xml rel=alternate type=application/rss+xml>
<link rel=canonical href=https://cerds.github.io/deployments/juju/>
<link rel=stylesheet href=https://cerds.github.io/css/theme.min.css>
<script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script>
<link rel=stylesheet href=https://cerds.github.io/css/chroma.min.css>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>
<script src=https://cerds.github.io/js/bundle.js></script><style>:root{}</style>
<meta property="og:title" content="Juju deployment">
<meta property="og:description" content="JAAS
Client setup sudo snap install juju --classic Simplestreams $ openstack image list $ cd $(mktemp -d) $ mkdir simplestreams $ juju metadata generate-image -a amd64 -d ./simplestreams -i 90303547-6dd7-42f8-a173-fe4f5902ed30 -r RegionOne -s focal -u https://nimbus.pawsey.org.au:5000/v3 $ juju metadata generate-image -a amd64 -d ./simplestreams -i 3a0daf62-69f0-42fd-90ff-e8fea01f7531 -r RegionOne -s bionic -u https://nimbus.pawsey.org.au:5000/v3 Image metadata files have been written to: /tmp/tmp.GTcJ2OUBed/simplestreams/images/streams/v1. For Juju to use this metadata, the files need to be put into the image metadata search path.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://cerds.github.io/deployments/juju/"><meta property="article:section" content="deployments">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Juju deployment">
<meta name=twitter:description content="JAAS
Client setup sudo snap install juju --classic Simplestreams $ openstack image list $ cd $(mktemp -d) $ mkdir simplestreams $ juju metadata generate-image -a amd64 -d ./simplestreams -i 90303547-6dd7-42f8-a173-fe4f5902ed30 -r RegionOne -s focal -u https://nimbus.pawsey.org.au:5000/v3 $ juju metadata generate-image -a amd64 -d ./simplestreams -i 3a0daf62-69f0-42fd-90ff-e8fea01f7531 -r RegionOne -s bionic -u https://nimbus.pawsey.org.au:5000/v3 Image metadata files have been written to: /tmp/tmp.GTcJ2OUBed/simplestreams/images/streams/v1. For Juju to use this metadata, the files need to be put into the image metadata search path.">
<meta itemprop=name content="Juju deployment">
<meta itemprop=description content="JAAS
Client setup sudo snap install juju --classic Simplestreams $ openstack image list $ cd $(mktemp -d) $ mkdir simplestreams $ juju metadata generate-image -a amd64 -d ./simplestreams -i 90303547-6dd7-42f8-a173-fe4f5902ed30 -r RegionOne -s focal -u https://nimbus.pawsey.org.au:5000/v3 $ juju metadata generate-image -a amd64 -d ./simplestreams -i 3a0daf62-69f0-42fd-90ff-e8fea01f7531 -r RegionOne -s bionic -u https://nimbus.pawsey.org.au:5000/v3 Image metadata files have been written to: /tmp/tmp.GTcJ2OUBed/simplestreams/images/streams/v1. For Juju to use this metadata, the files need to be put into the image metadata search path.">
<meta itemprop=wordCount content="474">
<meta itemprop=keywords content></head>
<body><div class=container><header>
<h1>Characterisation eResearch & Data Science (CeRDS)</h1>
</header>
<div class=global-menu>
<nav>
<ul>
<li><a href=/>Home</a></li></ul>
</nav>
</div>
<div class=content-container>
<main><h1>Juju deployment</h1>
<p><a href=https://jaas.ai/>JAAS</a></p>
<h2 id=client-setup>Client setup</h2>
<pre tabindex=0><code class=language-console data-lang=console>sudo snap install juju --classic
</code></pre><h2 id=simplestreams>Simplestreams</h2>
<pre tabindex=0><code class=language-console data-lang=console>$ openstack image list
$ cd $(mktemp -d)
$ mkdir simplestreams

$ juju metadata generate-image -a amd64 -d ./simplestreams -i 90303547-6dd7-42f8-a173-fe4f5902ed30 -r RegionOne -s focal -u https://nimbus.pawsey.org.au:5000/v3
$ juju metadata generate-image -a amd64 -d ./simplestreams -i 3a0daf62-69f0-42fd-90ff-e8fea01f7531 -r RegionOne -s bionic -u https://nimbus.pawsey.org.au:5000/v3
Image metadata files have been written to:
/tmp/tmp.GTcJ2OUBed/simplestreams/images/streams/v1.
For Juju to use this metadata, the files need to be put into the
image metadata search path. There are 2 options:

1. For local access, use the --metadata-source parameter when bootstrapping:
   juju bootstrap --metadata-source /tmp/tmp.GTcJ2OUBed/simplestreams [...]

2. For remote access, use image-metadata-url attribute for model configuration.
To set it as a default for any model or for the controller model,
it needs to be supplied as part of --model-default to 'juju bootstrap' command.
See 'bootstrap' help for more details.
For configuration for a particular model, set it as --image-metadata-url on
'juju model-config'. See 'model-config' help for more details.
Regardless of where this attribute is used, it expects a reachable URL.
You need to configure a http server to serve the contents of
/tmp/tmp.GTcJ2OUBed/simplestreams
and set the value of image-metadata-url accordingly.

$ cd simplestreams
$ mc mb store/simplestreams
$ mc cp -r * store/simplestreams
$ mc policy set download store/simplestreams

$ cd $(mktemp -d)
$ mc mirror store/simplestreams
$ juju metadata generate-image -a amd64 -d . -i f210c2f1-2d03-4e07-80ab-cf606d550d69 -r RegionOne -s bionic -u https://nimbus.pawsey.org.au:5000/v3
$ mc mirror . store/simplesreams --overrite
</code></pre><p>Can be accessed via the url <a href=https://store.s3.cerds.org.au/simplestreams>https://store.s3.cerds.org.au/simplestreams</a></p>
<h2 id=bootstrap-controller>Bootstrap controller</h2>
<pre tabindex=0><code class=language-console data-lang=console>$ juju bootstrap --bootstrap-series=focal --image-metadata-url=&quot;https://store.s3.cerds.org.au/simplestreams&quot;
</code></pre><h2 id=image-convert-to-raw>Image convert to RAW</h2>
<pre tabindex=0><code class=language-console data-lang=console>$ wget https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64-disk-kvm.img
$ sha256sum focal-server-cloudimg-amd64-disk-kvm.img | grep 93631c31efe4dbe104ef10ef1b33a8358a444523a5c741294c6e51ce6193cab4
$ qemu-img convert -Oraw focal-server-cloudimg-amd64-disk-kvm.img focal-server-cloudimg.raw
$ openstack image create --container-format bare --disk-format raw --min-disk 3 --min-ram 500 --file focal-server-cloudimg.raw --shared focal-server-cloudimg
</code></pre><p>Download the kvm qcow2 disk images from the official Ubuntu cloud image repository. Nimbus uses Ceph storage as the backing medium for their OpenStack service, for performance/snapshot functionality the image needs to be converted from QCOW2 to RAW before being uploaded to the OpenStack image service within the Project.</p>
<h2 id=kubernetes>Kubernetes</h2>
<p>References</p>
<pre tabindex=0><code class=language-console data-lang=console>wget https://api.jujucharms.com/charmstore/v5/charmed-kubernetes-545/archive/bundle.yaml
wget https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/calico-overlay.yaml
wget https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/openstack-overlay.yaml
</code></pre><pre tabindex=0><code class=language-console data-lang=console>juju add-model k8s
juju deploy cs:~containers/charmed-kubernetes-545 --overlay overlay.yaml --overlay calico-overlay.yaml --overlay openstack-overlay.yaml --trust
</code></pre><p>overlay.yaml</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=color:#f92672>applications</span>:
  <span style=color:#f92672>easyrsa</span>:
    <span style=color:#f92672>to</span>: [<span style=color:#e6db74>&#34;lxd:kubernetes-master&#34;</span>]
  <span style=color:#f92672>etcd</span>:
    <span style=color:#f92672>to</span>: [<span style=color:#e6db74>&#34;lxd:kubernetes-master&#34;</span>]
  <span style=color:#f92672>kubernetes-master</span>:
    <span style=color:#f92672>constraints</span>: <span style=color:#ae81ff>cores=4 mem=4G root-disk=16G</span>
    <span style=color:#f92672>num_units</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#f92672>kubernetes-worker</span>:
    <span style=color:#f92672>constraints</span>: <span style=color:#ae81ff>cores=8 mem=4G root-disk=16G</span>
    <span style=color:#f92672>num_units</span>: <span style=color:#ae81ff>3</span>
</code></pre></div><p>calico-overlay.yaml</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Charmed Kubernetes overlay to add Calico CNI.</span>
<span style=color:#f92672>applications</span>:
  <span style=color:#f92672>calico</span>:
    <span style=color:#f92672>annotations</span>:
      <span style=color:#f92672>gui-x</span>: <span style=color:#e6db74>&#39;480&#39;</span>
      <span style=color:#f92672>gui-y</span>: <span style=color:#e6db74>&#39;750&#39;</span>
    <span style=color:#f92672>charm</span>: <span style=color:#ae81ff>cs:~containers/calico</span>
    <span style=color:#f92672>options</span>:
      <span style=color:#f92672>cidr</span>: <span style=color:#e6db74>&#34;10.1.0.0/16&#34;</span>
      <span style=color:#f92672>disable-vxlan-tx-checksumming</span>: <span style=color:#66d9ef>false</span>
      <span style=color:#f92672>ignore-loose-rpf</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#f92672>ipip</span>: <span style=color:#e6db74>&#34;Never&#34;</span>
      <span style=color:#f92672>manage-pools</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#f92672>nat-outgoing</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#f92672>node-to-node-mesh</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#f92672>veth-mtu</span>: <span style=color:#ae81ff>1500</span>
      <span style=color:#f92672>vxlan</span>: <span style=color:#e6db74>&#34;Always&#34;</span>
  <span style=color:#f92672>flannel</span>:
<span style=color:#f92672>relations</span>:
- - <span style=color:#ae81ff>calico:etcd</span>
  - <span style=color:#ae81ff>etcd:db</span>
- - <span style=color:#ae81ff>calico:cni</span>
  - <span style=color:#ae81ff>kubernetes-master:cni</span>
- - <span style=color:#ae81ff>calico:cni</span>
  - <span style=color:#ae81ff>kubernetes-worker:cni</span>
</code></pre></div><p>openstack-overlay.yaml</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Charmed Kubernetes overlay to add native OpenStack support.</span>
<span style=color:#f92672>applications</span>:
  <span style=color:#f92672>openstack-integrator</span>:
    <span style=color:#f92672>annotations</span>:
      <span style=color:#f92672>gui-x</span>: <span style=color:#e6db74>&#34;600&#34;</span>
      <span style=color:#f92672>gui-y</span>: <span style=color:#e6db74>&#34;300&#34;</span>
    <span style=color:#f92672>charm</span>: <span style=color:#ae81ff>cs:~containers/openstack-integrator</span>
    <span style=color:#f92672>num_units</span>: <span style=color:#ae81ff>1</span>
    <span style=color:#f92672>options</span>:
      <span style=color:#f92672>bs-version</span>: <span style=color:#e6db74>&#34;auto&#34;</span>
      <span style=color:#f92672>ignore-volume-az</span>: <span style=color:#66d9ef>false</span>
      <span style=color:#f92672>trust-device-path</span>: <span style=color:#66d9ef>false</span>
    <span style=color:#f92672>to</span>: [<span style=color:#e6db74>&#34;lxd:kubernetes-master&#34;</span>]
    <span style=color:#f92672>trust</span>: <span style=color:#66d9ef>true</span>
<span style=color:#f92672>relations</span>:
  - [<span style=color:#e6db74>&#39;openstack-integrator&#39;</span>, <span style=color:#e6db74>&#39;kubernetes-master:openstack&#39;</span>]
  - [<span style=color:#e6db74>&#39;openstack-integrator&#39;</span>, <span style=color:#e6db74>&#39;kubernetes-worker:openstack&#39;</span>]
</code></pre></div><div class=edit-meta>
<br></div><nav class=pagination><a class="nav nav-prev" href=https://cerds.github.io/deployments/ title=Deployments><i class="fas fa-arrow-left" aria-hidden=true></i>&nbsp;Prev - Deployments</a>
<a class="nav nav-next" href=https://cerds.github.io/accs/ title=Accs>Next - Accs <i class="fas fa-arrow-right" aria-hidden=true></i></a>
</nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p>
</footer>
</main>
<div class=sidebar>
<nav class=open-menu>
<ul>
<li><a href=https://cerds.github.io/>Home</a></li>
<li><a href=https://cerds.github.io/accs/>Accs</a>
<ul class=sub-menu>
<li><a href=https://cerds.github.io/accs/cvl/>CVL@UWA</a></li>
</ul>
</li>
<li class=parent><a href=https://cerds.github.io/deployments/>Deployments</a>
<ul class=sub-menu>
<li class=active><a href=https://cerds.github.io/deployments/juju/>Juju deployment</a></li>
</ul>
</li>
</ul>
</nav>
<div class=sidebar-footer></div>
</div>
</div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20>
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>